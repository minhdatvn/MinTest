{% extends 'quiz_app/base.html' %}

{% block title %}Tìm kiếm Câu hỏi{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Tìm kiếm Câu hỏi Nâng cao</h1>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            Bộ lọc tìm kiếm
        </div>
        <div class="card-body">
            {# Form tìm kiếm sẽ gửi dữ liệu bằng phương thức GET #}
            <form method="get" action="{% url 'question_search' %}">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="{{ form.keyword.id_for_label }}" class="form-label">{{ form.keyword.label }}</label>
                        {{ form.keyword }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.topic_group.id_for_label }}" class="form-label">{{ form.topic_group.label }}</label>
                        {{ form.topic_group }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.topic.id_for_label }}" class="form-label">{{ form.topic.label }}</label>
                        {{ form.topic }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.question_type.id_for_label }}" class="form-label">{{ form.question_type.label }}</label>
                        {{ form.question_type }}
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Tìm kiếm</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="search-results-container">
        {% include 'quiz_app/_question_search_results.html' %}
    </div>

    {# MODAL MỚI ĐỂ HIỂN THỊ CHI TIẾT CÂU HỎI #}
    <div class="modal fade" id="questionDetailModal" tabindex="-1" aria-labelledby="questionDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionDetailModalLabel">Chi tiết câu hỏi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="questionDetailModalBody">
                    {# Nội dung sẽ được tải vào đây bằng JavaScript #}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LOGIC DROPDOWN PHỤ THUỘC (PHIÊN BẢN SỬA LỖI) ---
    const topicGroupSelect = document.getElementById('id_topic_group');
    const topicSelect = document.getElementById('id_topic');

    if (topicGroupSelect && topicSelect) {

        // Hàm để reset và vô hiệu hóa dropdown Chủ đề
        const resetTopicDropdown = () => {
            topicSelect.innerHTML = '<option value="">Tất cả các Chủ đề</option>';
            topicSelect.disabled = true;
        };

        // Vô hiệu hóa dropdown Chủ đề ngay khi tải trang
        // nếu chưa có Nhóm chủ đề nào được chọn sẵn
        if (!topicGroupSelect.value) {
            resetTopicDropdown();
        }

        topicGroupSelect.addEventListener('change', function() {
            const groupId = this.value;

            // Nếu người dùng chọn "Tất cả các Nhóm", reset và vô hiệu hóa dropdown
            if (!groupId) {
                resetTopicDropdown();
                return;
            }

            // Nếu chọn một nhóm cụ thể, kích hoạt dropdown và hiển thị trạng thái "Đang tải..."
            topicSelect.disabled = false;
            topicSelect.innerHTML = '<option value="">Đang tải chủ đề...</option>';

            // Gọi API
            const url = `{% url 'api_get_topics' %}?group_id=${groupId}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Xóa trạng thái "Đang tải..."
                    topicSelect.innerHTML = '';
                    // Thêm lại lựa chọn mặc định
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Tất cả các Chủ đề';
                    topicSelect.appendChild(defaultOption);

                    // Thêm các chủ đề lấy về từ API
                    if (data.topics) {
                        data.topics.forEach(function(topic) {
                            const option = document.createElement('option');
                            option.value = topic.id;
                            option.textContent = topic.topic_name;
                            topicSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi lấy danh sách chủ đề:', error);
                    resetTopicDropdown(); // Reset nếu có lỗi
                });
        });
    }

    // --- LOGIC TÌM KIẾM VÀ PHÂN TRANG BẰNG AJAX (GIỮ NGUYÊN) ---
    const searchForm = document.querySelector('form[method="get"]');
    const resultsContainer = document.getElementById('search-results-container');

    if (searchForm) {
        searchForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(searchForm);
            const searchParams = new URLSearchParams(formData);
            const queryString = searchParams.toString();
            const url = `{% url 'question_search' %}?${queryString}`;

            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                resultsContainer.innerHTML = html;
                history.pushState(null, '', url);
            })
            .catch(error => console.error('Lỗi khi tìm kiếm:', error));
        });
    }

    resultsContainer.addEventListener('click', function(event) {
        if (event.target.tagName === 'A' && event.target.classList.contains('page-link')) {
            event.preventDefault();
            const url = event.target.href;
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                resultsContainer.innerHTML = html;
                history.pushState(null, '', url);
            });
        }
    });

    // --- MODAL XEM CHI TIẾT CÂU HỎI ---
    const detailModal = document.getElementById('questionDetailModal');
    if (detailModal) {
        detailModal.addEventListener('show.bs.modal', function(event) {
            const link = event.relatedTarget;
            const questionId = link.dataset.questionId;
            const modalBody = document.getElementById('questionDetailModalBody');

            modalBody.innerHTML = '<p class="text-center">Đang tải chi tiết...</p>';

            fetch(`/api/question-details/${questionId}/`)
                .then(response => response.json())
                .then(data => {
                    // DEBUG 1: In ra toàn bộ dữ liệu nhận được từ server
                    console.log("--- DEBUG: Dữ liệu nhận được từ server ---");
                    console.log(data);

                    if (data.success) {
                        let contentHtml = `<p><strong>${data.question_text}</strong></p><hr>`;
                        contentHtml += '<ul class="list-group">';

                        data.answers.forEach(answer => {
                            const itemClass = answer.is_correct ? 'list-group-item list-group-item-success' : 'list-group-item';
                            contentHtml += `<li class="${itemClass}">${answer.text}</li>`;
                        });

                        contentHtml += '</ul>';
                        modalBody.innerHTML = contentHtml;
                    } else {
                        modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    }
                })
                .catch(error => {
                    console.error("Lỗi:", error);
                    modalBody.innerHTML = '<div class="alert alert-danger">Không thể tải dữ liệu. Vui lòng thử lại.</div>';
                });
        });
    }
});
</script>
{% endblock %}