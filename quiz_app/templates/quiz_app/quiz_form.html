{% extends 'quiz_app/base.html' %}

{% block title %}Tạo Đề thi Mới{% endblock %}

{% block content %}
    <style>
        /* Tùy chỉnh nhỏ cho danh sách câu hỏi và các panel */
        .question-checklist {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: .375rem;
            padding: 1rem;
        }
        .form-check {
            margin-bottom: 0.5rem;
        }
        /* Style cho các lựa chọn radio của quiz_type */
        .quiz-type-chooser .form-check {
            display: inline-block;
            margin-right: 1rem;
        }
    </style>

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Tạo Đề thi Mới</h1>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                {% endif %}

                {# CÁC TRƯỜNG CHUNG #}
                <div class="mb-3">
                    <label for="{{ form.quiz_name.id_for_label }}" class="form-label">{{ form.quiz_name.label }}</label>
                    <input type="text" name="{{ form.quiz_name.name }}" id="{{ form.quiz_name.id_for_label }}" class="form-control" required>
                    {{ form.quiz_name.errors }}
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.time_limit_minutes.id_for_label }}" class="form-label">{{ form.time_limit_minutes.label }}</label>
                        <input type="number" name="{{ form.time_limit_minutes.name }}" value="15" id="{{ form.time_limit_minutes.id_for_label }}" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ form.scoring_scale_max.id_for_label }}" class="form-label">{{ form.scoring_scale_max.label }}</label>
                        <input type="number" name="{{ form.scoring_scale_max.name }}" value="100" id="{{ form.scoring_scale_max.id_for_label }}" class="form-control" required>
                    </div>
                </div>

                <hr>

                {# BỘ CHUYỂN ĐỔI LOẠI ĐỀ THI #}
                <div class="mb-3">
                    <label class="form-label">{{ form.quiz_type.label }}</label>
                    <div class="quiz-type-chooser">
                        {{ form.quiz_type }}
                    </div>
                </div>

                {# PANEL CHO ĐỀ THI TĨNH - PHIÊN BẢN CÂY THƯ MỤC #}
                <div id="static-quiz-panel">
                    <div class="mb-3">
                        {# THAY ĐỔI 1: Thêm bộ đếm vào label #}
                        <label class="form-label">
                            Chọn các câu hỏi cho đề thi (Đã chọn: <span id="selected-question-count" class="fw-bold">0</span>)
                        </label>

                        {% if form.questions.errors %}
                            <div class="alert alert-danger">{{ form.questions.errors }}</div>
                        {% endif %}

                        <div class="question-checklist accordion" id="questionAccordion">
                            {% for group in topic_groups_with_questions %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-group-{{ group.id }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-group-{{ group.id }}">
                                            {# THAY ĐỔI 2: Thêm checkbox "Chọn tất cả" cho nhóm #}
                                            <input type="checkbox" class="form-check-input me-2 group-select-all" data-group-id="{{ group.id }}">
                                            <strong>{{ group.group_name }}</strong>
                                        </button>
                                    </h2>
                                    <div id="collapse-group-{{ group.id }}" class="accordion-collapse collapse" data-bs-parent="#questionAccordion">
                                        <div class="accordion-body">
                                            {% for topic in group.topics_with_questions %}
                                                <div class="topic-container mt-2">
                                                    <h5>
                                                        <input type="checkbox" class="form-check-input me-2 topic-select-all" 
                                                            data-topic-id="{{ topic.id }}" 
                                                            data-group-id="{{ group.id }}">
                                                        {{ topic.topic_name }}
                                                    </h5>
                                                    {% for question in topic.questions.all %}
                                                        <div class="form-check">
                                                            {# THAY ĐỔI 3: Thêm class và data-group-id cho từng câu hỏi #}
                                                            <input class="form-check-input question-checkbox" type="checkbox" name="questions" value="{{ question.id }}" id="question-{{ question.id }}" data-group-id="{{ group.id }}" data-topic-id="{{ topic.id }}">
                                                            <label class="form-check-label" for="question-{{ question.id }}">
                                                                {{ question.question_text|truncatechars:100 }}
                                                            </label>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# PANEL CHO ĐỀ THI ĐỘNG #}
                <div id="dynamic-quiz-panel" class="d-none">
                    <p class="form-text">Chọn số lượng câu hỏi ngẫu nhiên sẽ được lấy từ mỗi chủ đề bên dưới. Bỏ trống hoặc điền 0 nếu không muốn lấy câu hỏi từ chủ đề đó.</p>

                    <div class="row">
                        {# Lặp qua tất cả các trường trong form #}
                        {% for field in form %}
                            {# Chỉ hiển thị các trường được tạo ra cho đề thi động #}
                            {% if 'dynamic_topic_' in field.name %}
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ field.label_tag }}
                                        {{ field }}
                                        {{ field.errors }}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                </div>

                <div class="mt-4">
                    {# Bộ nút cho panel tĩnh #}
                    <div id="static-quiz-actions">
                        <button type="submit" class="btn btn-success">Lưu Đề thi</button>
                        <a href="{% url 'quiz_list' %}" class="btn btn-secondary ms-2">Hủy bỏ</a>
                    </div>

                    {# Bộ nút cho panel động #}
                    <div id="dynamic-quiz-actions" class="d-none">
                        <button type="submit" class="btn btn-success">Lưu Mẫu đề thi</button>
                        <button type="button" class="btn btn-info ms-2" id="take-now-btn">Làm bài ngay</button>
                        <a href="{% url 'quiz_list' %}" class="btn btn-secondary ms-2">Hủy bỏ</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- PHẦN 1: LOGIC CHUNG VÀ CHUYỂN ĐỔI PANEL ---
    const mainForm = document.querySelector('form[method="post"]');
    if (!mainForm) return;

    const staticPanel = document.getElementById('static-quiz-panel');
    const dynamicPanel = document.getElementById('dynamic-quiz-panel');
    const quizTypeRadios = document.querySelectorAll('input[name="quiz_type"]');
    const staticActions = document.getElementById('static-quiz-actions');
    const dynamicActions = document.getElementById('dynamic-quiz-actions');

    function togglePanels() {
        // Đảm bảo các phần tử tồn tại trước khi thao tác
        if (!staticPanel || !dynamicPanel || !staticActions || !dynamicActions) return;

        const selectedType = document.querySelector('input[name="quiz_type"]:checked').value;

        if (selectedType === 'static') {
            // Dùng classList để thêm/xóa class 'd-none'
            staticPanel.classList.remove('d-none');
            dynamicPanel.classList.add('d-none');
            staticActions.classList.remove('d-none');
            dynamicActions.classList.add('d-none');
        } else if (selectedType === 'dynamic') {
            staticPanel.classList.add('d-none');
            dynamicPanel.classList.remove('d-none');
            staticActions.classList.add('d-none');
            dynamicActions.classList.remove('d-none');
        }
    }

    if (quizTypeRadios.length > 0) {
        quizTypeRadios.forEach(radio => radio.addEventListener('change', togglePanels));
        togglePanels();
    }

    const takeNowBtn = document.getElementById('take-now-btn');
    if (takeNowBtn) {
        takeNowBtn.addEventListener('click', function() {
            mainForm.action = "{% url 'take_dynamic_quiz_now' %}";
            mainForm.submit();
        });
    }
           
    // === PHẦN 2: LOGIC CHO BỘ ĐẾM VÀ CHECKBOX "CHỌN TẤT CẢ" ===
    const countSpan = document.getElementById('selected-question-count');
    const allQuestionCheckboxes = document.querySelectorAll('.question-checkbox');
    const groupSelectAllCheckboxes = document.querySelectorAll('.group-select-all');
    const topicSelectAllCheckboxes = document.querySelectorAll('.topic-select-all');

    // HÀM CẬP NHẬT BỘ ĐẾM (KHÔNG ĐỔI)
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.question-checkbox:checked').length;
        if (countSpan) countSpan.textContent = selectedCount;
    }

    // HÀM MỚI: Cập nhật trạng thái checkbox của CHỦ ĐỀ
    function updateTopicSelectAllState(topicId) {
        const masterCheckbox = document.querySelector(`.topic-select-all[data-topic-id="${topicId}"]`);
        const childCheckboxes = document.querySelectorAll(`.question-checkbox[data-topic-id="${topicId}"]`);
        if (!masterCheckbox || childCheckboxes.length === 0) return;

        const total = childCheckboxes.length;
        const checkedCount = document.querySelectorAll(`.question-checkbox[data-topic-id="${topicId}"]:checked`).length;

        if (checkedCount === 0) {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = false;
        } else if (checkedCount === total) {
            masterCheckbox.checked = true;
            masterCheckbox.indeterminate = false;
        } else {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = true;
        }
    }

    // HÀM CẬP NHẬT TRẠNG THÁI CHECKBOX CỦA NHÓM
    function updateGroupSelectAllState(groupId) {
        const masterCheckbox = document.querySelector(`.group-select-all[data-group-id="${groupId}"]`);
        const childCheckboxes = document.querySelectorAll(`.question-checkbox[data-group-id="${groupId}"]`);
        if (!masterCheckbox || childCheckboxes.length === 0) return;

        const total = childCheckboxes.length;
        const checkedCount = document.querySelectorAll(`.question-checkbox[data-group-id="${groupId}"]:checked`).length;

        if (checkedCount === 0) {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = false;
        } else if (checkedCount === total) {
            masterCheckbox.checked = true;
            masterCheckbox.indeterminate = false;
        } else {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = true;
        }
    }

    // SỰ KIỆN KHI BẤM VÀO CHECKBOX "CHỌN TẤT CẢ" CỦA NHÓM (CẬP NHẬT)
    groupSelectAllCheckboxes.forEach(masterCheckbox => {
        masterCheckbox.addEventListener('change', function() {
            const groupId = this.dataset.groupId;
            const isChecked = this.checked;
            // Chọn tất cả các câu hỏi con
            document.querySelectorAll(`.question-checkbox[data-group-id="${groupId}"]`)
                    .forEach(child => child.checked = isChecked);
            // Cập nhật luôn trạng thái của các checkbox chủ đề con
            document.querySelectorAll(`.topic-select-all[data-group-id="${groupId}"]`)
                    .forEach(topicMaster => {
                        topicMaster.checked = isChecked;
                        topicMaster.indeterminate = false;
                    });
            updateSelectedCount();
        });
    });

    // SỰ KIỆN MỚI: KHI BẤM VÀO CHECKBOX "CHỌN TẤT CẢ" CỦA CHỦ ĐỀ
    topicSelectAllCheckboxes.forEach(topicMasterCheckbox => {
        topicMasterCheckbox.addEventListener('change', function() {
            const topicId = this.dataset.topicId;
            const groupId = this.dataset.groupId;
            const isChecked = this.checked;
            document.querySelectorAll(`.question-checkbox[data-topic-id="${topicId}"]`)
                    .forEach(child => child.checked = isChecked);
            updateSelectedCount();
            updateGroupSelectAllState(groupId); // Cập nhật lại checkbox của nhóm cha
        });
    });

    // SỰ KIỆN KHI BẤM VÀO TỪNG CÂU HỎI (CẬP NHẬT)
    allQuestionCheckboxes.forEach(childCheckbox => {
        childCheckbox.addEventListener('change', function() {
            const groupId = this.dataset.groupId;
            const topicId = this.dataset.topicId;
            updateTopicSelectAllState(topicId); // Cập nhật checkbox chủ đề
            updateGroupSelectAllState(groupId); // Cập nhật checkbox nhóm
            updateSelectedCount();
        });
    });

    // Khởi tạo trạng thái đúng khi tải trang
    if (staticPanel) {
        updateSelectedCount();
        topicSelectAllCheckboxes.forEach(master => updateTopicSelectAllState(master.dataset.topicId));
        groupSelectAllCheckboxes.forEach(master => updateGroupSelectAllState(master.dataset.groupId));
    }
});
</script>
{% endblock %}