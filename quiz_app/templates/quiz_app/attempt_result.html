{% extends 'quiz_app/base.html' %}
{% load quiz_extras %}

{% block title %}K·∫øt qu·∫£: {{ attempt.quiz.quiz_name }}{% endblock %}

{% block content %}
    <div style="display:none;">{% csrf_token %}</div>
    <style>
        body {
            /* Th√™m padding-bottom ƒë·ªÉ thanh ƒëi·ªÅu h∆∞·ªõng kh√¥ng che m·∫•t n·ªôi dung */
            padding-bottom: 120px; 
        }
        .result-nav-panel {
            top: auto !important;
            bottom: 0;
            /* S·ª¨A L·∫†I: D√πng bi·∫øn cho m√†u n·ªÅn */
            background-color: var(--bs-tertiary-bg); 
            border-top: 1px solid var(--bs-border-color);
            z-index: 1020;
        }
        .result-nav-box {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid var(--bs-border-color);
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            /* S·ª¨A L·∫†I: D√πng bi·∫øn cho m√†u n·ªÅn v√† m√†u ch·ªØ */
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            user-select: none;
            transition: transform 0.2s;
        }
        .result-nav-box:hover {
            transform: scale(1.1);
        }
        .result-nav-box.active {
            /* Bootstrap s·∫Ω t·ª± x·ª≠ l√Ω m√†u cho tr·∫°ng th√°i active */
            background-color: var(--bs-primary);
            color: var(--bs-light);
            border-color: var(--bs-primary);
        }
        .result-nav-box.correct-result { background-color: #198754; color: white; }
        .result-nav-box.incorrect-result { background-color: #dc3545; color: white; }
        
        .question-review { border-top: 1px solid var(--bs-border-color); padding-top: 15px; }
        .answer-option { display: block; padding: 8px; margin: 4px 0; border-radius: 4px; list-style-type: none; }
        
        .selected-by-user { 
            border-left: 5px solid var(--bs-primary); 
            /* S·ª¨A L·∫†I: D√πng bi·∫øn cho m√†u n·ªÅn */
            background-color: var(--bs-primary-bg-subtle); 
        }
        .correct-answer { 
            /* S·ª¨A L·∫†I: D√πng bi·∫øn cho m√†u ch·ªØ v√† n·ªÅn */
            color: var(--bs-success-text-emphasis); 
            background-color: var(--bs-success-bg-subtle); 
        }
        .incorrect-selection { 
            /* S·ª¨A L·∫†I: D√πng bi·∫øn cho m√†u ch·ªØ, n·ªÅn v√† vi·ªÅn */
            color: var(--bs-danger-text-emphasis); 
            background-color: var(--bs-danger-bg-subtle); 
            border-left: 5px solid var(--bs-danger); 
        }
        @media (max-width: 767.98px) {
            .btn-responsive span {
                display: none;
            }
        }
    </style>

    <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="row justify-content-center">
                {# ƒê·ªïi th√†nh col-md-8 v√† mx-auto ƒë·ªÉ cƒÉn gi·ªØa sau khi x√≥a c·ªôt b√™n ph·∫£i #}
                <div class="col-md-8 text-center mb-3 mb-md-0">
                
                    {# KHU√îN ·∫¢NH GI·ªú L√Ä N·ªòI DUNG HI·ªÇN TH·ªä CH√çNH #}
                    <div id="result-card-to-capture" style="width: 100%; max-width: 450px; padding: 25px; background-color: white; border-radius: 15px; margin: auto;" class="shadow-sm">
                        
                        {# 1. T√™n ƒë·ªÅ thi hi·ªÉn th·ªã b√¨nh th∆∞·ªùng, kh√¥ng nghi√™ng, kh√¥ng c√≥ d·∫•u "" #}
                        <h3 style="text-align: center; margin-bottom: 5px; color: #333; font-size: 1.5rem; font-weight: bold;">
                            {{ share_quiz_name|escapejs }}
                        </h3>
            
                        {# 2. ƒê∆∞a "L∆∞·ª£t thi l√∫c" v√†o trong ·∫£nh #}
                        <p style="text-align: center; color: #6c757d; font-size: 0.9rem; margin-bottom: 20px;">
                            L∆∞·ª£t thi l√∫c: {{ attempt.start_time|date:"H:i, d/m/Y" }}
                        </p>
                        
                        {# Bi·ªÉu ƒë·ªì (kh√¥ng ƒë·ªïi) #}
                        <div style="position: relative; width: 140px; height: 140px; margin: auto;">
                            <canvas id="scoreChart"></canvas>
                            <div id="chart-score-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: bold; color: #333;">
                                {{ attempt.score_achieved|percentage:attempt.quiz.scoring_scale_max|floatformat:0 }}%
                            </div>
                        </div>
                        
                        {# ƒêi·ªÉm s·ªë (kh√¥ng ƒë·ªïi) #}
                        <p style="text-align: center; font-size: 1.3rem; font-weight: bold; margin: 15px 0 5px 0; color: #0d6efd;">
                            {{ attempt.score_achieved|floatformat:2 }} / {{ attempt.quiz.scoring_scale_max }}
                        </p>
                        
                        {# L·ªùi b√¨nh lu·∫≠n v√† icon (kh√¥ng ƒë·ªïi) #}
                        {% with percentage=attempt.score_achieved|percentage:attempt.quiz.scoring_scale_max %}
                            <p style="text-align: center; font-size: 1.1rem; font-weight: bold; margin-bottom: 0;
                                      {% if percentage >= 85 %}color: #198754;{% elif percentage >= 50 %}color: #0d6efd;{% else %}color: #ffc107;{% endif %}">
                                {% if percentage >= 85 %}
                                    <i class="bi bi-trophy-fill"></i> Xu·∫•t s·∫Øc!
                                {% elif percentage >= 50 %}
                                    <i class="bi bi-hand-thumbs-up-fill"></i> L√†m t·ªët l·∫Øm!
                                {% elif percentage > 0 %}
                                    <i class="bi bi-emoji-smile-fill"></i> C·ªë g·∫Øng h∆°n nh√©!
                                {% else %}
                                    <i class="bi bi-tencent-qq"></i> H√™n xui th√¥i!
                                {% endif %}
                            </p>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center my-4">
            <div class="mb-3">
                <a href="{% url 'start_quiz' attempt.quiz.template_for.id|default:attempt.quiz.id %}" class="btn btn-primary d-inline-flex align-items-center btn-responsive" title="L√†m l·∫°i b√†i thi n√†y">
                    <i class="bi bi-arrow-clockwise"></i><span class="ms-1">L√†m l·∫°i</span>
                </a>
            
                <a href="{% if user.is_authenticated %}{% url 'dashboard' %}{% else %}{% url 'guest_homepage' %}{% endif %}" class="btn btn-secondary ms-2 d-inline-flex align-items-center btn-responsive" title="Quay l·∫°i trang ch√≠nh">
                    <i class="bi bi-house-door-fill"></i><span class="ms-1">Trang ch·ªß</span>
                </a>
                
                <button type="button" id="share-result-btn" class="btn btn-success ms-2 d-inline-flex align-items-center btn-responsive" title="Chia s·∫ª ·∫£nh k·∫øt qu·∫£">
                    <i class="bi bi-share-fill"></i><span class="ms-1">Chia s·∫ª K·∫øt qu·∫£</span>
                </button>
                <button type="button" id="invite-to-quiz-btn" class="btn btn-info ms-2 d-inline-flex align-items-center btn-responsive" title="M·ªùi ng∆∞·ªùi kh√°c l√†m b√†i thi n√†y">
                    <i class="bi bi-send-fill"></i><span class="ms-1">M·ªùi l√†m b√†i</span>
                </button>
            </div>

            <div class="d-inline-flex align-items-center">
                <span class="me-2">Hi·ªÉn th·ªã k·∫øt qu·∫£ thi:</span>
                <div class="btn-group" role="group" aria-label="L·ªçc k·∫øt qu·∫£">
                    <button type="button" class="btn btn-sm btn-outline-secondary filter-btn" data-filter="all">T·∫•t c·∫£</button>
                    <button type="button" class="btn btn-sm btn-outline-success filter-btn" data-filter="correct">ƒê√∫ng</button>
                    <button type="button" class="btn btn-sm btn-outline-danger filter-btn" data-filter="incorrect">Sai</button>
                </div>
            </div>

        </div>

    <div class="review-container card d-none">
        <div class="card-header">
            <h2 class="mb-0">K·∫øt qu·∫£ chi ti·∫øt b√†i thi:</h2>
        </div>
        <div class="card-body">
            {% for answered_question in ordered_answered_questions %}
                <div class="result-question-container {% if not forloop.first %}d-none{% endif %}" id="result-question-{{ forloop.counter0 }}">
                    <div class="question-review">
                        <h4>C√¢u <span class="question-number-display">{{ forloop.counter }}</span>: {{ answered_question.question.question_text }}</h4>
                        <p><i>K·∫øt qu·∫£: {% if answered_question.is_correct %}ƒê√∫ng{% else %}Sai{% endif %}. ƒê∆∞·ª£c: {{ answered_question.points_earned|floatformat:2 }} ƒëi·ªÉm</i></p>  

                        <ul>
                            {% for option in answered_question.question.answers.all %}
                                {% if option in answered_question.selected_answers.all %}
                                    {% if option.is_correct %}
                                        <li class="answer-option correct-answer selected-by-user">
                                            {{ forloop.counter0|to_char }}.
                                            {{ option.answer_text }} (ƒê√°p √°n b·∫°n ch·ªçn ƒë√∫ng)
                                        </li>
                                    {% else %}
                                        <li class="answer-option incorrect-selection">
                                            {{ forloop.counter0|to_char }}.
                                            {{ option.answer_text }} (ƒê√°p √°n b·∫°n ch·ªçn sai)
                                        </li>
                                    {% endif %}
                                {% else %}
                                    {% if option.is_correct %}
                                        <li class="answer-option correct-answer">
                                            {{ forloop.counter0|to_char }}.
                                            {{ option.answer_text }} (ƒê√°p √°n ƒë√∫ng c·ªßa c√¢u h·ªèi)
                                        </li>
                                    {% else %}
                                        <li class="answer-option">
                                            {{ forloop.counter0|to_char }}.
                                            {{ option.answer_text }}
                                        </li>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <nav class="navbar fixed-bottom result-nav-panel py-3 d-none">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <button type="button" id="prev-result-btn" class="btn btn-primary d-inline-flex align-items-center" title="C√¢u tr∆∞·ªõc" disabled>
                <i class="bi bi-arrow-left-circle-fill fs-4"></i>
                <span class="d-none d-sm-inline ms-2">C√¢u tr∆∞·ªõc</span>
            </button>

            <button class="btn btn-outline-secondary d-inline-flex align-items-center" type="button" data-bs-toggle="offcanvas" data-bs-target="#resultNavOffcanvas" aria-controls="resultNavOffcanvas" title="Danh s√°ch c√¢u h·ªèi">
                <i class="bi bi-list-task fs-4"></i>
                <span class="d-none d-sm-inline ms-1">Danh s√°ch</span>
            </button>

            <button type="button" id="next-result-btn" class="btn btn-primary d-inline-flex align-items-center" title="C√¢u ti·∫øp">
                <span class="d-none d-sm-inline me-2">C√¢u ti·∫øp</span>
                <i class="bi bi-arrow-right-circle-fill fs-4"></i>
            </button>
        </div>        
    </nav>

    <div class="offcanvas offcanvas-bottom d-none" tabindex="-1" id="resultNavOffcanvas" aria-labelledby="offcanvasLabel" style="height: 30vh;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasLabel">ƒêi·ªÅu h∆∞·ªõng k·∫øt qu·∫£</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="result-navigator" class="d-flex flex-wrap justify-content-center gap-2 mx-auto">
                {% for answered_question in ordered_answered_questions %}
                    <div class="result-nav-box {% if answered_question.is_correct %}correct-result{% else %}incorrect-result{% endif %} {% if forloop.first %}active{% endif %}"
                         data-question-index="{{ forloop.counter0 }}">
                        {{ forloop.counter }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {# MODAL D·ª∞ PH√íNG CHO VI·ªÜC CHIA S·∫∫ #}
    <div class="modal fade" id="shareResultModal" tabindex="-1" aria-labelledby="shareResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareResultModalLabel">Chia s·∫ª k·∫øt qu·∫£ c·ªßa b·∫°n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ chia s·∫ª tr·ª±c ti·∫øp. Vui l√≤ng sao ch√©p n·ªôi dung d∆∞·ªõi ƒë√¢y v√† d√°n v√†o n∆°i b·∫°n mu·ªën chia s·∫ª.</p>
                    <textarea id="share-text-content" class="form-control" rows="6" readonly></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" id="copy-share-text-btn" class="btn btn-primary">
                        <i class="bi bi-clipboard"></i> Sao ch√©p n·ªôi dung
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
    {# N·∫°p th∆∞ vi·ªán html-to-image #}
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    {# N·∫°p th∆∞ vi·ªán Chart.js t·ª´ CDN #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- PH·∫¶N 1: LOGIC ƒêI·ªÄU H∆Ø·ªöNG & L·ªåC K·∫æT QU·∫¢ (PH·∫¶N B·ªä THI·∫æU) ---
            const reviewContainer = document.querySelector('.review-container');
            const navPanel = document.querySelector('.result-nav-panel');
            const offcanvasPanel = document.getElementById('resultNavOffcanvas');
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            const questionContainers = document.querySelectorAll('.result-question-container');
            const allNavBoxes = document.querySelectorAll('.result-nav-box');
            const nextBtn = document.getElementById('next-result-btn');
            const prevBtn = document.getElementById('prev-result-btn');
            const totalQuestions = questionContainers.length;
            let currentQuestionIndex = 0;
            let visibleNavBoxes = Array.from(allNavBoxes); // M·∫£ng ch·ª©a c√°c √¥ s·ªë ƒëang hi·ªÉn th·ªã

            function showQuestion(index) {
                const actualIndexToShow = visibleNavBoxes.indexOf(allNavBoxes[index]);
                if (actualIndexToShow === -1) return;

                questionContainers.forEach(container => container.classList.add('d-none'));
                if (questionContainers[index]) {
                    questionContainers[index].classList.remove('d-none');
                }

                allNavBoxes.forEach(box => box.classList.remove('active'));
                if (allNavBoxes[index]) {
                    allNavBoxes[index].classList.add('active');
                }

                currentQuestionIndex = index;
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Prev/Next d·ª±a tr√™n danh s√°ch *ƒë√£ l·ªçc*
                const firstVisibleIndex = parseInt(visibleNavBoxes[0].dataset.questionIndex, 10);
                const lastVisibleIndex = parseInt(visibleNavBoxes[visibleNavBoxes.length - 1].dataset.questionIndex, 10);
                
                if(prevBtn) prevBtn.disabled = (currentQuestionIndex === firstVisibleIndex);
                if(nextBtn) nextBtn.disabled = (currentQuestionIndex === lastVisibleIndex);
            }

            if (nextBtn) nextBtn.addEventListener('click', () => {
                const currentVisibleIndex = visibleNavBoxes.indexOf(allNavBoxes[currentQuestionIndex]);
                if (currentVisibleIndex < visibleNavBoxes.length - 1) {
                    const nextQuestionGlobalIndex = parseInt(visibleNavBoxes[currentVisibleIndex + 1].dataset.questionIndex, 10);
                    showQuestion(nextQuestionGlobalIndex);
                }
            });

            if (prevBtn) prevBtn.addEventListener('click', () => {
                const currentVisibleIndex = visibleNavBoxes.indexOf(allNavBoxes[currentQuestionIndex]);
                if (currentVisibleIndex > 0) {
                    const prevQuestionGlobalIndex = parseInt(visibleNavBoxes[currentVisibleIndex - 1].dataset.questionIndex, 10);
                    showQuestion(prevQuestionGlobalIndex);
                }
            });
            
            allNavBoxes.forEach(box => {
                box.addEventListener('click', function () {
                    const index = parseInt(this.dataset.questionIndex, 10);
                    showQuestion(index);
                });
            });

            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (reviewContainer && reviewContainer.classList.contains('d-none')) {
                        reviewContainer.classList.remove('d-none');
                        navPanel.classList.remove('d-none');
                        offcanvasPanel.classList.remove('d-none');
                        reviewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }        

                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.dataset.filter;
                    visibleNavBoxes = []; // Reset l·∫°i danh s√°ch

                    allNavBoxes.forEach(navBox => {
                        let show = false;
                        if (filter === 'all') {
                            show = true;
                        } else if (filter === 'correct' && navBox.classList.contains('correct-result')) {
                            show = true;
                        } else if (filter === 'incorrect' && navBox.classList.contains('incorrect-result')) {
                            show = true;
                        }
                        navBox.style.display = show ? 'flex' : 'none';
                        if (show) {
                            visibleNavBoxes.push(navBox);
                        }
                    });

                    if (visibleNavBoxes.length > 0) {
                        const firstVisibleQuestionIndex = parseInt(visibleNavBoxes[0].dataset.questionIndex, 10);
                        showQuestion(firstVisibleQuestionIndex);
                    } else {
                        questionContainers.forEach(container => container.classList.add('d-none'));
                    }
                });
            });

            if (totalQuestions > 0) {
                showQuestion(0);
            }

            // === PH·∫¶N V·∫º BI·ªÇU ƒê·ªí  ===
            const userScore = parseFloat('{{ attempt.score_achieved|default:0|stringformat:".2f" }}');
            const maxScore = parseFloat('{{ attempt.quiz.scoring_scale_max|default:100|stringformat:".2f" }}');
            const chartCanvas = document.getElementById('scoreChart');
            if (chartCanvas) {
                new Chart(chartCanvas, {
                    type: 'doughnut',
                    data: { datasets: [{ data: [userScore, Math.max(0, maxScore - userScore)], backgroundColor: ['#198754', '#e9ecef'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
                });
            }

            // === PH·∫¶N CHIA S·∫∫ V√Ä M·ªúI (LOGIC M·ªöI) ===
            const shareBtn = document.getElementById('share-result-btn');
            const inviteBtn = document.getElementById('invite-to-quiz-btn');

            if (shareBtn && inviteBtn) {
                const shareModalEl = document.getElementById('shareResultModal');
                const shareModal = new bootstrap.Modal(shareModalEl);
                const shareTextArea = document.getElementById('share-text-content');
                const copyBtn = document.getElementById('copy-share-text-btn');

                // --- H√ÄM 1: X·ª≠ l√Ω n√∫t "Chia s·∫ª K·∫øt qu·∫£" (chia s·∫ª ·∫£nh) ---
                async function handleShareResult() {
                    const nodeToCapture = document.getElementById('result-card-to-capture');
                    try {
                        const dataUrl = await htmlToImage.toPng(nodeToCapture, { quality: 0.95, pixelRatio: 2 });
                        const blob = await (await fetch(dataUrl)).blob();
                        const file = new File([blob], "ket-qua-thi.png", { type: "image/png" });

                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: 'K·∫øt qu·∫£ thi MinTest c·ªßa t√¥i!',
                                text: 'ƒê√¢y l√† k·∫øt qu·∫£ b√†i thi c·ªßa t√¥i tr√™n MinTest.',
                            });
                            return;
                        }
                    } catch (err) {
                        console.error("L·ªói khi chia s·∫ª ·∫£nh, chuy·ªÉn sang ph∆∞∆°ng √°n d·ª± ph√≤ng:", err);
                    }
                    alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ chia s·∫ª h√¨nh ·∫£nh.');
                }

                // --- H√ÄM 2: X·ª≠ l√Ω n√∫t "M·ªùi l√†m b√†i" (chia s·∫ª text/link) ---
                function handleInvite() {
                    const quizName = '{{ share_quiz_name|escapejs }}';
                    const url = '{{ homepage_url }}';
                    const accessCode = '{{ share_access_code|default:"" }}';

                    let inviteText = `üìù M·ªùi b·∫°n th·ª≠ s·ª©c v·ªõi ƒë·ªÅ thi "${quizName}" tr√™n MinTest!\n\n`;
                    if (accessCode) {
                        inviteText += `S·ª≠ d·ª•ng m√£ tham gia: ${accessCode}\n\n`;
                    }
                    inviteText += `L√†m b√†i t·∫°i ƒë√¢y:\n${url}`;

                    // S·ª≠ d·ª•ng Web Share API cho vƒÉn b·∫£n
                    if (navigator.share) {
                        navigator.share({
                            title: `M·ªùi l√†m b√†i thi: ${quizName}`,
                            text: inviteText,
                        }).catch((err) => console.error("L·ªói khi chia s·∫ª:", err));
                    } else {
                        // Ph∆∞∆°ng √°n d·ª± ph√≤ng: Hi·ªán modal ƒë·ªÉ copy/paste
                        shareTextArea.value = inviteText;
                        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Sao ch√©p l·ªùi m·ªùi';
                        shareModal.show();
                    }
                }

                // G·∫Øn s·ª± ki·ªán cho t·ª´ng n√∫t
                shareBtn.addEventListener('click', handleShareResult);
                inviteBtn.addEventListener('click', handleInvite);
                
                // Logic n√∫t sao ch√©p trong modal (d√πng chung cho c·∫£ 2)
                copyBtn.addEventListener('click', function() {
                    shareTextArea.select();
                    navigator.clipboard.writeText(shareTextArea.value).then(() => {
                        copyBtn.innerHTML = '<i class="bi bi-clipboard-check-fill text-success"></i> ƒê√£ ch√©p!';
                    });
                });
            }
        });
    </script>
{% endblock %}