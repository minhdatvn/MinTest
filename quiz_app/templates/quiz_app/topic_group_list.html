{% extends 'quiz_app/base.html' %}

{% block title %}Quản lý Nội dung{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Quản lý Nội dung</h1>
    </div>

    <div class="mb-4">
        {# NÚT TẠO NHÓM ĐÚNG ĐỂ KÍCH HOẠT MODAL #}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
            <i class="bi bi-plus-circle"></i> Tạo Nhóm Mới
        </button>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#createTopicModal">
            <i class="bi bi-folder-plus"></i> Tạo Chủ đề Mới
        </button>
        <a href="{% url 'import_all_data' %}" class="btn btn-info"><i class="bi bi-file-earmark-arrow-up-fill"></i> Nhập Toàn Bộ</a>
        <a href="{% url 'export_all_select' %}" class="btn btn-success"><i class="bi bi-box-arrow-down"></i> Xuất Toàn Bộ</a>
    </div>

    <div class="accordion" id="topicGroupAccordion">
        {% for group in topic_groups %}
            <div class="accordion-item" id="group-card-{{ group.id }}">
                <h2 class="accordion-header" id="heading-{{ group.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ group.id }}" aria-expanded="false" aria-controls="collapse-{{ group.id }}">
                        <strong class="me-2">{{ group.group_name }}</strong>
                        <span class="badge bg-secondary rounded-pill">{{ group.topic_set.count }} chủ đề</span>
                    </button>
                </h2>
                <div id="collapse-{{ group.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ group.id }}" data-bs-parent="#topicGroupAccordion">
                    <div class="accordion-body">
                        <div class="mb-3 border-bottom pb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary edit-group-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editGroupModal"
                                    data-group-url="{% url 'update_topic_group' group.id %}">
                                Sửa tên nhóm
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-group-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteConfirmModal"
                                    data-group-name="{{ group.group_name }}"
                                    data-delete-url="{% url 'delete_topic_group' group.id %}"
                                    data-group-id="{{ group.id }}">
                                Xóa nhóm
                            </button>
                        </div>
                        {% if group.topic_set.all %}
                            <div class="list-group">
                                {% for topic in group.topic_set.all %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center" id="topic-row-{{ topic.id }}"> 
                                        <div>
                                            <a href="{% url 'question_list_in_topic' topic.id %}" class="text-decoration-none text-dark fw-bold">{{ topic.topic_name }}</a>
                                            <span class="badge bg-light text-dark rounded-pill">{{ topic.questions.count }} câu hỏi</span>
                                            {% if topic.description %}<p class="mb-0 text-muted small">{{ topic.description }}</p>{% endif %}
                                        </div>
                                        <div class="item-actions">
                                            {% if perms.quiz_app.change_topic %}
                                            <button type="button" class="btn btn-sm btn-light edit-topic-btn" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editTopicModal"
                                                    data-topic-url="{% url 'update_topic' topic.id %}">
                                                Sửa
                                            </button>
                                            {% endif %}
                                            {% if perms.quiz_app.delete_topic %}
                                            <button type="button" class="btn btn-sm btn-light text-danger ms-1 delete-topic-btn"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#deleteConfirmModal"
                                                    data-topic-name="{{ topic.topic_name }}"
                                                    data-delete-url="{% url 'delete_topic' topic.id %}"
                                                    data-topic-id="{{ topic.id }}">
                                                Xóa
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">Nhóm này chưa có chủ đề nào.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="alert alert-info">
                Bạn chưa có nhóm chủ đề nào. Hãy bắt đầu bằng cách <a href="{% url 'create_topic_group' %}" class="alert-link">tạo một nhóm mới</a>!
            </div>
        {% endfor %}
    </div>

    {# MODAL TẠO NHÓM CHỦ ĐỀ MỚI #}
    <div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createModalLabel">Tạo Nhóm Chủ đề Mới</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="createGroupForm">
                <div class="mb-3">
                    <label for="newGroupName" class="form-label">Tên Nhóm chủ đề</label>
                    <input type="text" class="form-control" id="newGroupName" required>
                    <div class="invalid-feedback" id="nameError"></div>
                </div>
                <div class="mb-3">
                    <label for="newGroupDescription" class="form-label">Mô tả (tùy chọn)</label>
                    <textarea class="form-control" id="newGroupDescription" rows="3"></textarea>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
            <button type="button" id="saveNewGroupBtn" class="btn btn-primary">Lưu</button>
          </div>
        </div>
      </div>
    </div>

    {# MODAL SỬA NHÓM CHỦ ĐỀ #}
    <div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editGroupModalLabel">Chỉnh sửa Nhóm Chủ đề</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editGroupForm">
                        <input type="hidden" id="editGroupUrl">
                        <div class="mb-3">
                            <label for="editGroupName" class="form-label">Tên Nhóm chủ đề</label>
                            <input type="text" class="form-control" id="editGroupName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGroupDescription" class="form-label">Mô tả (tùy chọn)</label>
                            <textarea class="form-control" id="editGroupDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="button" id="updateGroupBtn" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    {# MODAL XÓA NHÓM CHỦ ĐỀ #}
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Xác nhận Xóa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Bạn có chắc chắn muốn xóa nhóm chủ đề <strong id="groupNameToDelete"></strong>?
            <p class="text-muted small mt-2">Lưu ý: Tất cả các chủ đề con sẽ được chuyển vào nhóm "Các chủ đề khác".</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Xác nhận Xóa</button>
          </div>
        </div>
      </div>
    </div>

    {# MODAL TẠO CHỦ ĐỀ MỚI #}
    <div class="modal fade" id="createTopicModal" tabindex="-1" aria-labelledby="createTopicModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createTopicModalLabel">Tạo Chủ đề Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createTopicForm">
                        <div class="mb-3">
                            <label for="newTopicName" class="form-label">Tên Chủ đề</label>
                            <input type="text" class="form-control" id="newTopicName" required>
                            <div class="invalid-feedback" id="topicNameError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="newTopicDescription" class="form-label">Mô tả (tùy chọn)</label>
                            <textarea class="form-control" id="newTopicDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="topicGroupSelect" class="form-label">Chọn Nhóm chủ đề</label>
                            <select class="form-select" id="topicGroupSelect">
                                <option value="">Không chọn (sẽ vào nhóm mặc định)</option>
                                {% for group in topic_groups %}
                                    <option value="{{ group.id }}">{{ group.group_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="button" id="saveNewTopicBtn" class="btn btn-primary">Lưu Chủ đề</button>
                </div>
            </div>
        </div>
    </div>

    {# MODAL SỬA CHỦ ĐỀ #}
    <div class="modal fade" id="editTopicModal" tabindex="-1" aria-labelledby="editTopicModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTopicModalLabel">Chỉnh sửa Chủ đề</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTopicForm">
                        {# Thêm một input ẩn để lưu URL cập nhật #}
                        <input type="hidden" id="editTopicUrl">
                        <div class="mb-3">
                            <label for="editTopicName" class="form-label">Tên Chủ đề</label>
                            <input type="text" class="form-control" id="editTopicName" required>
                            <div class="invalid-feedback" id="editTopicNameError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editTopicDescription" class="form-label">Mô tả (tùy chọn)</label>
                            <textarea class="form-control" id="editTopicDescription" rows="3"></textarea>
                        </div>
                        {# Chúng ta sẽ không cho sửa nhóm trong modal này để đơn giản hóa #}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="button" id="updateTopicBtn" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- PHẦN 1: KHAI BÁO CÁC BIẾN DÙNG CHUNG ---
    function getCookie(name) {
        // ... (hàm getCookie giữ nguyên)
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const createModalEl = document.getElementById('createGroupModal');
    const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
    
    if (!deleteConfirmModalEl) return;

    const deleteModal = new bootstrap.Modal(deleteConfirmModalEl);
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let urlToDelete = '';
    let elementToRemove = null;

    // --- PHẦN 2: LẮNG NGHE SỰ KIỆN KHI MODAL XÁC NHẬN XÓA ĐƯỢC MỞ ---
    deleteConfirmModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        urlToDelete = button.getAttribute('data-delete-url');
        const modalBody = deleteConfirmModalEl.querySelector('.modal-body');

        // Phân biệt xem nút được nhấn là xóa Nhóm hay xóa Chủ đề
        if (button.classList.contains('delete-topic-btn')) {
            const topicName = button.getAttribute('data-topic-name');
            const topicId = button.getAttribute('data-topic-id');
            elementToRemove = document.getElementById(`topic-row-${topicId}`);
            modalBody.innerHTML = `Bạn có chắc chắn muốn xóa chủ đề <strong>"${topicName}"</strong>? <br><small class="text-danger">Tất cả câu hỏi bên trong chủ đề này cũng sẽ bị xóa. Hành động không thể hoàn tác.</small>`;
        
        } else if (button.classList.contains('delete-group-btn')) {
            const groupName = button.getAttribute('data-group-name');
            const groupId = button.getAttribute('data-group-id');
            elementToRemove = document.getElementById(`group-card-${groupId}`);
            modalBody.innerHTML = `Bạn có chắc chắn muốn xóa nhóm chủ đề <strong>"${groupName}"</strong>?
                                   <p class="text-muted small mt-2">Lưu ý: Tất cả các chủ đề con sẽ được chuyển vào nhóm "Các chủ đề khác".</p>`;
        }
    });

    // --- PHẦN 3: LẮNG NGHE SỰ KIỆN KHI NHẤN NÚT "XÁC NHẬN XÓA" (Phiên bản cuối) ---
    confirmDeleteBtn.addEventListener('click', function() {
        if (!urlToDelete || !elementToRemove) return;

        fetch(urlToDelete, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const isDeletingTopic = elementToRemove.id.startsWith('topic-row-');
                const isDeletingGroup = elementToRemove.id.startsWith('group-card-');
                const parentContainer = elementToRemove.parentElement;

                elementToRemove.style.transition = 'opacity 0.5s ease';
                elementToRemove.style.opacity = '0';
                
                setTimeout(() => {
                    elementToRemove.remove(); // Xóa element khỏi DOM

                    // Logic xử lý sau khi xóa một CHỦ ĐỀ
                    if (isDeletingTopic) {
                        const listGroup = parentContainer;
                        if (listGroup.children.length === 0) {
                            const accordionBody = listGroup.parentElement;
                            const badge = accordionBody.previousElementSibling.querySelector('.badge');
                            if(badge) badge.textContent = '0 chủ đề';
                            const emptyMsg = document.createElement('p');
                            emptyMsg.className = 'text-muted';
                            emptyMsg.textContent = 'Nhóm này chưa có chủ đề nào.';
                            accordionBody.appendChild(emptyMsg);
                            listGroup.remove();
                        } else {
                            const badge = listGroup.parentElement.previousElementSibling.querySelector('.badge');
                            if(badge) {
                                let currentCount = parseInt(badge.textContent) || 0;
                                badge.textContent = `${currentCount - 1} chủ đề`;
                            }
                        }
                    }

                    // Logic xử lý sau khi xóa một NHÓM CHỦ ĐỀ
                    if (isDeletingGroup) {
                        const accordion = parentContainer;
                        if (accordion.children.length === 0) {
                            const emptyMsgHtml = `<div class="alert alert-info">Bạn chưa có nhóm chủ đề nào. Hãy bắt đầu bằng cách <a href="#" class="alert-link" data-bs-toggle="modal" data-bs-target="#createGroupModal">tạo một nhóm mới</a>!</div>`;
                            accordion.insertAdjacentHTML('beforebegin', emptyMsgHtml);
                            accordion.remove();
                        }
                    }
                    
                    // *** THAY ĐỔI QUAN TRỌNG NHẤT LÀ Ở ĐÂY ***
                    // Dọn dẹp biến BÊN TRONG setTimeout để đảm bảo nó chạy cuối cùng
                    urlToDelete = '';
                    elementToRemove = null;

                }, 500);
                
                deleteModal.hide();
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => console.error('Error:', error)); // Khối .finally() đã được xóa đi
    });

    // ================= LOGIC XỬ LÝ TẠO NHÓM MỚI (Giữ nguyên) =================
    if(createModalEl) {
        const createModal = new bootstrap.Modal(createModalEl);
        const saveNewGroupBtn = document.getElementById('saveNewGroupBtn');
        const createGroupForm = document.getElementById('createGroupForm');
        const newGroupNameInput = document.getElementById('newGroupName');
        const newGroupDescInput = document.getElementById('newGroupDescription');
        const accordionContainer = document.getElementById('topicGroupAccordion');

        saveNewGroupBtn.addEventListener('click', function() {
            const groupName = newGroupNameInput.value.trim();
            const groupDesc = newGroupDescInput.value.trim();
            if (groupName === '') {
                alert('Tên Nhóm chủ đề không được để trống.');
                return;
            }

            fetch("{% url 'create_topic_group' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({ 'group_name': groupName, 'group_description': groupDesc })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const newGroup = data.new_group;
                    // ... (phần code tạo HTML cho nhóm mới giữ nguyên như cũ)
                    const newGroupHtml = `
                        <div class="accordion-item" id="group-card-${newGroup.id}">
                            <h2 class="accordion-header" id="heading-${newGroup.id}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${newGroup.id}" aria-expanded="false" aria-controls="collapse-${newGroup.id}">
                                    <strong class="me-2">${newGroup.name}</strong>
                                    <span class="badge bg-secondary rounded-pill">0 chủ đề</span>
                                </button>
                            </h2>
                            <div id="collapse-${newGroup.id}" class="accordion-collapse collapse" aria-labelledby="heading-${newGroup.id}" data-bs-parent="#topicGroupAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3 border-bottom pb-2">
                                         <a href="/group/${newGroup.id}/edit/" class="btn btn-sm btn-outline-secondary">Sửa tên nhóm</a>
                                         <button type="button" class="btn btn-sm btn-outline-danger delete-group-btn"
                                                 data-bs-toggle="modal" data-bs-target="#deleteConfirmModal"
                                                 data-group-name="${newGroup.name}"
                                                 data-delete-url="/group/${newGroup.id}/delete/"
                                                 data-group-id="${newGroup.id}">
                                             Xóa nhóm
                                         </button>
                                    </div>
                                    <p class="text-muted">Nhóm này chưa có chủ đề nào.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    accordionContainer.insertAdjacentHTML('afterbegin', newGroupHtml);
                    createModal.hide();
                    createGroupForm.reset();
                } else {
                    alert('Lỗi: ' + JSON.stringify(data.errors));
                }
            })
            .catch(error => console.error('Lỗi khi tạo nhóm mới:', error));
        });
    }

    // ================= LOGIC XỬ LÝ SỬA NHÓM CHỦ ĐỀ =================
    const editGroupModalEl = document.getElementById('editGroupModal');
    if (editGroupModalEl) {
        const editGroupModal = new bootstrap.Modal(editGroupModalEl);
        const editGroupUrlInput = document.getElementById('editGroupUrl');
        const editGroupNameInput = document.getElementById('editGroupName');
        const editGroupDescInput = document.getElementById('editGroupDescription');

        // Khi modal SỬA được mở -> Gửi yêu cầu GET để lấy dữ liệu
        editGroupModalEl.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const groupUrl = button.getAttribute('data-group-url');
            editGroupUrlInput.value = groupUrl;

            fetch(groupUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.json())
            .then(data => {
                editGroupNameInput.value = data.name;
                editGroupDescInput.value = data.description;
            });
        });

        // Khi nhấn nút "Lưu thay đổi" -> Gửi yêu cầu POST để cập nhật
        document.getElementById('updateGroupBtn').addEventListener('click', function() {
            const groupUrl = editGroupUrlInput.value;
            const updatedData = {
                group_name: editGroupNameInput.value.trim(),
                group_description: editGroupDescInput.value.trim(),
            };

            fetch(groupUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const group = data.group;
                    // Cập nhật tên nhóm trên header của accordion (dòng này đã có)
                    const groupCard = document.getElementById(`group-card-${group.id}`);
                    if (groupCard) {
                        groupCard.querySelector('h2 button strong').textContent = group.name;

                        // ================= BẮT ĐẦU CODE MỚI =================
                        // Đồng bộ hóa tên mới vào trong dropdown của modal "Tạo Chủ đề"
                        const topicGroupSelect = document.getElementById('topicGroupSelect');
                        if (topicGroupSelect) {
                            // Tìm đúng thẻ <option> có value khớp với id của nhóm vừa sửa
                            const optionToUpdate = topicGroupSelect.querySelector(`option[value="${group.id}"]`);
                            if (optionToUpdate) {
                                // Cập nhật lại text hiển thị của thẻ option đó
                                optionToUpdate.textContent = group.name;
                            }
                        }
                        // ================= KẾT THÚC CODE MỚI =================
                    }
                    editGroupModal.hide();
                } else {
                    alert('Lỗi: ' + JSON.stringify(data.errors));
                }
            });
        });
    }

    // ================= LOGIC XỬ LÝ TẠO CHỦ ĐỀ MỚI =================
    const createTopicModalEl = document.getElementById('createTopicModal');
    if (createTopicModalEl) {
        const createTopicModal = new bootstrap.Modal(createTopicModalEl);
        const saveNewTopicBtn = document.getElementById('saveNewTopicBtn');
        
        saveNewTopicBtn.addEventListener('click', function() {
            // 1. Thu thập dữ liệu từ form trong modal
            const topicName = document.getElementById('newTopicName').value.trim();
            const topicDesc = document.getElementById('newTopicDescription').value.trim();
            const groupId = document.getElementById('topicGroupSelect').value;

            if (topicName === '') {
                alert('Tên Chủ đề không được để trống.');
                return;
            }

            // 2. Gửi yêu cầu AJAX đến server
            fetch("{% url 'create_topic' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken, // Biến này đã được định nghĩa ở các script trên
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({ 
                    'topic_name': topicName, 
                    'description': topicDesc, 
                    'group': groupId 
                })
            })
            .then(response => response.json())
            .then(data => {
                // 3. Xử lý kết quả server trả về
                if (data.success) {
                    const topic = data.topic;

                    // 3A. Tạo HTML cho dòng chủ đề mới
                    const newTopicHtml = `
                        <div class="list-group-item d-flex justify-content-between align-items-center" id="topic-row-${topic.id}">
                            <div>
                                <a href="${topic.question_list_url}" class="text-decoration-none text-dark fw-bold">${topic.name}</a>
                                <span class="badge bg-light text-dark rounded-pill">${topic.question_count} câu hỏi</span>
                                ${topic.description ? `<p class="mb-0 text-muted small">${topic.description}</p>` : ''}
                            </div>
                            <div class="item-actions">
                                <button type="button" class="btn btn-sm btn-light edit-topic-btn" 
                                        data-bs-toggle="modal" data-bs-target="#editTopicModal"
                                        data-topic-url="${topic.update_url}">
                                    Sửa
                                </button>
                                <button type="button" class="btn btn-sm btn-light text-danger ms-1 delete-topic-btn"
                                        data-bs-toggle="modal" data-bs-target="#deleteConfirmModal"
                                        data-topic-name="${topic.name}" data-delete-url="${topic.delete_url}"
                                        data-topic-id="${topic.id}">
                                    Xóa
                                </button>
                            </div>
                        </div>`;
                    
                    // 3B. Tìm đúng nhóm để chèn chủ đề mới vào và cập nhật UI
                    const groupCollapseDiv = document.getElementById(`collapse-${topic.group_id}`);
                    if (groupCollapseDiv) {
                        const accordionBody = groupCollapseDiv.querySelector('.accordion-body');
                        let listGroup = accordionBody.querySelector('.list-group');

                        // Nếu nhóm này chưa có chủ đề nào (chỉ có thẻ <p> thông báo)
                        if (!listGroup) {
                            const emptyMsg = accordionBody.querySelector('.text-muted');
                            if (emptyMsg) emptyMsg.remove(); // Xóa thông báo rỗng
                            
                            listGroup = document.createElement('div');
                            listGroup.className = 'list-group';
                            accordionBody.appendChild(listGroup);
                        }

                        // Chèn chủ đề mới vào cuối danh sách
                        listGroup.insertAdjacentHTML('beforeend', newTopicHtml);
                        
                        // Cập nhật số đếm chủ đề trên header của nhóm
                        const badge = groupCollapseDiv.previousElementSibling.querySelector('.badge');
                        if (badge) {
                            let currentCount = parseInt(badge.textContent) || 0;
                            badge.textContent = `${currentCount + 1} chủ đề`;
                        }
                    }

                    // 3C. Đóng modal và xóa dữ liệu trong form
                    createTopicModal.hide();
                    document.getElementById('createTopicForm').reset();
                } else {
                    // Hiển thị lỗi nếu có (ví dụ: tên chủ đề bị trùng)
                    alert('Lỗi: ' + JSON.stringify(data.errors));
                }
            })
            .catch(error => console.error('Lỗi khi tạo chủ đề mới:', error));
        });
    }

    // ================= LOGIC XỬ LÝ SỬA CHỦ ĐỀ =================
    const editTopicModalEl = document.getElementById('editTopicModal');
    if (editTopicModalEl) {
        const editTopicModal = new bootstrap.Modal(editTopicModalEl);
        const editTopicUrlInput = document.getElementById('editTopicUrl');
        const editTopicNameInput = document.getElementById('editTopicName');
        const editTopicDescInput = document.getElementById('editTopicDescription');

        // 1. Khi modal SỬA được mở -> Gửi yêu cầu GET để lấy dữ liệu
        editTopicModalEl.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const topicUrl = button.getAttribute('data-topic-url');
            editTopicUrlInput.value = topicUrl; // Lưu URL vào input ẩn

            // Lấy dữ liệu topic hiện tại từ server
            fetch(topicUrl, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                // Điền dữ liệu vào form
                editTopicNameInput.value = data.name;
                editTopicDescInput.value = data.description;
            });
        });

        // 2. Khi nhấn nút "Lưu thay đổi" -> Gửi yêu cầu POST để cập nhật
        document.getElementById('updateTopicBtn').addEventListener('click', function() {
            const topicUrl = editTopicUrlInput.value;
            const updatedData = {
                topic_name: editTopicNameInput.value.trim(),
                description: editTopicDescInput.value.trim(),
            };

            fetch(topicUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const topic = data.topic;
                    // Cập nhật giao diện ngay tại chỗ
                    const topicRow = document.getElementById(`topic-row-${topic.id}`);
                    if (topicRow) {
                        topicRow.querySelector('.fw-bold').textContent = topic.name;
                        let descElement = topicRow.querySelector('.text-muted.small');
                        if (topic.description) {
                            if (!descElement) {
                                descElement = document.createElement('p');
                                descElement.className = 'mb-0 text-muted small';
                                topicRow.querySelector('div').appendChild(descElement);
                            }
                            descElement.textContent = topic.description;
                        } else {
                            if (descElement) descElement.remove();
                        }
                    }
                    editTopicModal.hide();
                } else {
                    alert('Lỗi: ' + JSON.stringify(data.errors));
                }
            });
        });
    }
});
</script>
{% endblock %}