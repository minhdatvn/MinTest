{% extends 'quiz_app/guest_base.html' %}
{% block title %}Chào mừng đến với MinTest{% endblock %}

{% block content %}
<div class="text-center">
    <h1 class="display-4">Chào mừng đến với MinTest</h1>
    <p class="lead">Nền tảng tạo và làm bài thi trắc nghiệm trực tuyến</p>
</div>

<div class="row mt-5">
    {# CỘT TRÁI: DÀNH CHO KHÁCH LÀM BÀI #}
    <div class="col-md-7">
        <h4>Các đề thi công khai</h4>
        <p class="text-muted">Chọn một đề thi có sẵn để bắt đầu làm bài ngay không cần tài khoản.</p>
        <div class="list-group">
            {% for quiz in public_quizzes %}
                <a href="#" class="list-group-item list-group-item-action take-public-quiz-btn" 
                    data-bs-toggle="modal" 
                    data-bs-target="#guestNameModal" 
                    data-quiz-id="{{ quiz.id }}"
                    data-quiz-name="{{ quiz.quiz_name }}">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">{{ quiz.quiz_name }}</h5>
                        <small>{{ quiz.question_count }} câu hỏi</small>
                    </div>
                    <small>Thời gian: {{ quiz.time_limit_minutes }} phút.</small>
                </a>
            {% empty %}
                <p>Hiện chưa có đề thi công khai nào.</p>
            {% endfor %}
        </div>
        <hr class="my-4">
        <h4>...hoặc tham gia bằng mã</h4>
        <p class="text-muted">Nếu bạn có mã truy cập, hãy nhập mã và tên của bạn để bắt đầu.</p>
        <form action="{% url 'guest_start_quiz' %}" method="post">
            {% csrf_token %}
            <div class="row g-2">
                <div class="col-md">
                    <label for="guest-name-input" class="form-label visually-hidden">Tên của bạn</label>
                    <input type="text" name="guest_name" id="guest-name-input" class="form-control" placeholder="Nhập họ và tên của bạn..." required>
                </div>
                <div class="col-md">
                    <label for="access-code-input" class="form-label visually-hidden">Mã truy cập</label>
                    <input type="text" name="access_code" id="access-code-input" class="form-control" placeholder="Nhập mã truy cập..." required>
                </div>
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-primary w-100">Bắt đầu</button>
                </div>
            </div>
        </form>
    </div>

    {# CỘT PHẢI: DÀNH CHO THÀNH VIÊN ĐĂNG NHẬP #}
    <div class="col-md-5">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title text-center">Đăng nhập</h4>
                <form action="{% url 'login' %}" method="post">
                    {% csrf_token %}
                    {{ login_form.as_p }}
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success mt-3">Đăng nhập</button>
                    </div>
                </form>
                <p class="text-center mt-3">
                    Chưa có tài khoản? <a href="{% url 'signup' %}">Đăng ký ngay</a>
                </p>
            </div>
        </div>
    </div>
</div>

{# === MODAL MỚI: YÊU CẦU KHÁCH NHẬP TÊN === #}
<div class="modal fade" id="guestNameModal" tabindex="-1" aria-labelledby="guestNameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="{% url 'guest_start_quiz' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="quiz_id" id="guest-quiz-id-input">
                <div class="modal-header">
                    <h5 class="modal-title" id="guestNameModalLabel">Bắt đầu làm bài: <span id="modal-quiz-name"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Vui lòng nhập tên của bạn để chúng tôi có thể lưu lại kết quả.</p>
                    <input type="text" name="guest_name" class="form-control" placeholder="Nhập họ và tên của bạn..." required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                    <button type="submit" class="btn btn-success">Bắt đầu!</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const guestNameModalEl = document.getElementById('guestNameModal');
    if (guestNameModalEl) {
        const quizIdInput = document.getElementById('guest-quiz-id-input');
        const quizNameSpan = document.getElementById('modal-quiz-name');

        // Lắng nghe sự kiện click trên toàn bộ trang
        document.body.addEventListener('click', function(event) {
            const takeQuizButton = event.target.closest('.take-public-quiz-btn');
            if (takeQuizButton) {
                event.preventDefault(); // Ngăn thẻ <a> chuyển trang
                
                // Lấy thông tin từ nút được bấm và điền vào form trong modal
                const quizId = takeQuizButton.dataset.quizId;
                const quizName = takeQuizButton.dataset.quizName;

                quizIdInput.value = quizId;
                quizNameSpan.textContent = quizName;
            }
        });
    }
});
</script>
{% endblock %}